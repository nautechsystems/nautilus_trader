from collections.abc import Callable
from datetime import datetime
from typing import Any

from nautilus_trader.data.config import DataEngineConfig
from nautilus_trader.model.enums import BookType
from nautilus_trader.persistence.catalog.parquet import ParquetDataCatalog
from stubs.cache.cache import Cache
from stubs.common.component import Clock
from stubs.common.component import Component
from stubs.common.component import MessageBus
from stubs.common.component import TimeEvent
from stubs.core.data import Data
from stubs.core.uuid import UUID4
from stubs.data.aggregation import BarAggregator
from stubs.data.client import DataClient
from stubs.data.client import MarketDataClient
from stubs.data.messages import DataCommand
from stubs.data.messages import DataResponse
from stubs.data.messages import RequestBars
from stubs.data.messages import RequestData
from stubs.data.messages import RequestInstrument
from stubs.data.messages import RequestInstruments
from stubs.data.messages import RequestOrderBookSnapshot
from stubs.data.messages import RequestQuoteTicks
from stubs.data.messages import RequestTradeTicks
from stubs.data.messages import SubscribeBars
from stubs.data.messages import SubscribeData
from stubs.data.messages import SubscribeIndexPrices
from stubs.data.messages import SubscribeInstrument
from stubs.data.messages import SubscribeInstrumentClose
from stubs.data.messages import SubscribeInstruments
from stubs.data.messages import SubscribeInstrumentStatus
from stubs.data.messages import SubscribeMarkPrices
from stubs.data.messages import SubscribeOrderBook
from stubs.data.messages import SubscribeQuoteTicks
from stubs.data.messages import SubscribeTradeTicks
from stubs.data.messages import UnsubscribeBars
from stubs.data.messages import UnsubscribeData
from stubs.data.messages import UnsubscribeIndexPrices
from stubs.data.messages import UnsubscribeInstrument
from stubs.data.messages import UnsubscribeInstrumentClose
from stubs.data.messages import UnsubscribeInstruments
from stubs.data.messages import UnsubscribeInstrumentStatus
from stubs.data.messages import UnsubscribeMarkPrices
from stubs.data.messages import UnsubscribeOrderBook
from stubs.data.messages import UnsubscribeQuoteTicks
from stubs.data.messages import UnsubscribeTradeTicks
from stubs.model.book import OrderBook
from stubs.model.data import Bar
from stubs.model.data import BarType
from stubs.model.data import CustomData
from stubs.model.data import DataType
from stubs.model.data import IndexPriceUpdate
from stubs.model.data import InstrumentClose
from stubs.model.data import InstrumentStatus
from stubs.model.data import MarkPriceUpdate
from stubs.model.data import OrderBookDelta
from stubs.model.data import OrderBookDeltas
from stubs.model.data import OrderBookDepth10
from stubs.model.data import QuoteTick
from stubs.model.data import TradeTick
from stubs.model.identifiers import ClientId
from stubs.model.identifiers import InstrumentId
from stubs.model.identifiers import Venue
from stubs.model.instruments.base import Instrument
from stubs.model.instruments.synthetic import SyntheticInstrument

class DataEngine(Component):

    debug: bool
    command_count: int
    data_count: int
    request_count: int
    response_count: int

    _time_bars_interval_type: Any
    _time_bars_timestamp_on_close: bool
    _time_bars_skip_first_non_full_bar: bool
    _time_bars_build_with_no_updates: bool
    _time_bars_origin_offset: dict
    _time_bars_build_delay: int
    _validate_data_sequence: bool
    _buffer_deltas: bool
    _cache: Cache
    _clients: dict[ClientId, DataClient]
    _routing_map: dict[Venue, DataClient]
    _default_client: DataClient | None
    _external_clients: set[ClientId]
    _catalogs: dict[str, ParquetDataCatalog]
    _order_book_intervals: dict[tuple[InstrumentId, int], list[Callable[[OrderBook], None]]]
    _bar_aggregators: dict[BarType, BarAggregator]
    _synthetic_quote_feeds: dict[InstrumentId, list[SyntheticInstrument]]
    _synthetic_trade_feeds: dict[InstrumentId, list[SyntheticInstrument]]
    _subscribed_synthetic_quotes: list[InstrumentId]
    _subscribed_synthetic_trades: list[InstrumentId]
    _buffered_deltas_map: dict[InstrumentId, list[OrderBookDelta]]
    _snapshot_info: dict[str, SnapshotInfo]
    _query_group_n_responses: dict[UUID4, int]
    _query_group_responses: dict[UUID4, list]

    def __init__(
        self,
        msgbus: MessageBus,
        cache: Cache,
        clock: Clock,
        config: DataEngineConfig | None = None,
    ) -> None: ...
    @property
    def registered_clients(self) -> list[ClientId]: ...
    @property
    def default_client(self) -> ClientId | None: ...
    @property
    def routing_map(self) -> dict[Venue, DataClient]: ...
    def connect(self) -> None: ...
    def disconnect(self) -> None: ...
    def check_connected(self) -> bool: ...
    def check_disconnected(self) -> bool: ...
    def register_catalog(self, catalog: ParquetDataCatalog, name: str = "catalog_0") -> None: ...
    def register_client(self, client: DataClient) -> None: ...
    def register_default_client(self, client: DataClient) -> None: ...
    def register_venue_routing(self, client: DataClient, venue: Venue) -> None: ...
    def deregister_client(self, client: DataClient) -> None: ...
    def subscribed_custom_data(self) -> list[DataType]: ...
    def subscribed_instruments(self) -> list[InstrumentId]: ...
    def subscribed_order_book_deltas(self) -> list[InstrumentId]: ...
    def subscribed_order_book_snapshots(self) -> list[InstrumentId]: ...
    def subscribed_quote_ticks(self) -> list[InstrumentId]: ...
    def subscribed_trade_ticks(self) -> list[InstrumentId]: ...
    def subscribed_mark_prices(self) -> list[InstrumentId]: ...
    def subscribed_index_prices(self) -> list[InstrumentId]: ...
    def subscribed_bars(self) -> list[BarType]: ...
    def subscribed_instrument_status(self) -> list[InstrumentId]: ...
    def subscribed_instrument_close(self) -> list[InstrumentId]: ...
    def subscribed_synthetic_quotes(self) -> list[InstrumentId]: ...
    def subscribed_synthetic_trades(self) -> list[InstrumentId]: ...
    def _on_start(self) -> None: ...
    def _on_stop(self) -> None: ...
    def _start(self) -> None: ...
    def _stop(self) -> None: ...
    def _reset(self) -> None: ...
    def _dispose(self) -> None: ...
    def stop_clients(self) -> None: ...
    def execute(self, command: DataCommand) -> None: ...
    def process(self, data: Data) -> None: ...
    def request(self, request: RequestData) -> None: ...
    def response(self, response: DataResponse) -> None: ...
    def _execute_command(self, command: DataCommand) -> None: ...
    def _handle_subscribe(self, client: DataClient, command: SubscribeData) -> None: ...
    def _handle_unsubscribe(self, client: DataClient, command: UnsubscribeData) -> None: ...
    def _handle_subscribe_instruments(self, client: MarketDataClient, command: SubscribeInstruments) -> None: ...
    def _handle_subscribe_instrument(self, client: MarketDataClient, command: SubscribeInstrument) -> None: ...
    def _handle_subscribe_order_book_deltas(self, client: MarketDataClient, command: SubscribeOrderBook) -> None: ...
    def _handle_subscribe_order_book_depth(self, client: MarketDataClient, command: SubscribeOrderBook) -> None: ...
    def _handle_subscribe_order_book_snapshots(self, client: MarketDataClient, command: SubscribeOrderBook) -> None: ...
    def _setup_order_book(self, client: MarketDataClient, command: SubscribeOrderBook) -> None: ...
    def _create_new_book(self, instrument_id: InstrumentId, book_type: BookType) -> None: ...
    def _handle_subscribe_quote_ticks(self, client: MarketDataClient, command: SubscribeQuoteTicks) -> None: ...
    def _handle_subscribe_synthetic_quote_ticks(self, instrument_id: InstrumentId) -> None: ...
    def _handle_subscribe_trade_ticks(self, client: MarketDataClient, command: SubscribeTradeTicks) -> None: ...
    def _handle_subscribe_synthetic_trade_ticks(self, instrument_id: InstrumentId) -> None: ...
    def _handle_subscribe_mark_prices(self, client: MarketDataClient, command: SubscribeMarkPrices) -> None: ...
    def _handle_subscribe_index_prices(self, client: MarketDataClient, command: SubscribeIndexPrices) -> None: ...
    def _handle_subscribe_bars(self, client: MarketDataClient, command: SubscribeBars) -> None: ...
    def _handle_subscribe_data(self, client: DataClient, command: SubscribeData) -> None: ...
    def _handle_subscribe_instrument_status(self, client: MarketDataClient, command: SubscribeInstrumentStatus) -> None: ...
    def _handle_subscribe_instrument_close(self, client: MarketDataClient, command: SubscribeInstrumentClose) -> None: ...
    def _handle_unsubscribe_instruments(self, client: MarketDataClient, command: UnsubscribeInstruments) -> None: ...
    def _handle_unsubscribe_instrument(self, client: MarketDataClient, command: UnsubscribeInstrument) -> None: ...
    def _handle_unsubscribe_order_book_deltas(self, client: MarketDataClient, command: UnsubscribeOrderBook) -> None: ...
    def _handle_unsubscribe_order_book_snapshots(self, client: MarketDataClient, command: UnsubscribeOrderBook) -> None: ...
    def _handle_unsubscribe_quote_ticks(self, client: MarketDataClient, command: UnsubscribeQuoteTicks) -> None: ...
    def _handle_unsubscribe_trade_ticks(self, client: MarketDataClient, command: UnsubscribeTradeTicks) -> None: ...
    def _handle_unsubscribe_mark_prices(self, client: MarketDataClient, command: UnsubscribeMarkPrices) -> None: ...
    def _handle_unsubscribe_index_prices(self, client: MarketDataClient, command: UnsubscribeIndexPrices) -> None: ...
    def _handle_unsubscribe_bars(self, client: MarketDataClient, command: UnsubscribeBars) -> None: ...
    def _handle_unsubscribe_data(self, client: DataClient, command: UnsubscribeData) -> None: ...
    def _handle_unsubscribe_instrument_status(self, client: MarketDataClient, command: UnsubscribeInstrumentStatus) -> None: ...
    def _handle_unsubscribe_instrument_close(self, client: MarketDataClient, command: UnsubscribeInstrumentClose) -> None: ...
    def _handle_request(self, request: RequestData) -> None: ...
    def _handle_request_instruments(self, client: DataClient, request: RequestInstruments) -> None: ...
    def _handle_request_instrument(self, client: DataClient, request: RequestInstrument) -> None: ...
    def _handle_request_order_book_snapshot(self, client: DataClient, request: RequestOrderBookSnapshot) -> None: ...
    def _handle_request_quote_ticks(self, client: DataClient, request: RequestQuoteTicks) -> None: ...
    def _handle_request_trade_ticks(self, client: DataClient, request: RequestTradeTicks) -> None: ...
    def _handle_request_bars(self, client: DataClient, request: RequestBars) -> None: ...
    def _handle_request_data(self, client: DataClient, request: RequestData) -> None: ...
    def _handle_date_range_request(self, client: DataClient, request: RequestData) -> None: ...
    def _date_range_client_request(self, client: DataClient, request: RequestData) -> None: ...
    def _log_request_warning(self, request: RequestData) -> None: ...
    def _query_catalog(self, request: RequestData) -> None: ...
    def _handle_data(self, data: Data) -> None: ...
    def _handle_instrument(self, instrument: Instrument, update_catalog: bool = False, force_update_catalog: bool = False) -> None: ...
    def _handle_order_book_delta(self, delta: OrderBookDelta) -> None: ...
    def _handle_order_book_deltas(self, deltas: OrderBookDeltas) -> None: ...
    def _handle_order_book_depth(self, depth: OrderBookDepth10) -> None: ...
    def _handle_quote_tick(self, tick: QuoteTick) -> None: ...
    def _handle_trade_tick(self, tick: TradeTick) -> None: ...
    def _handle_mark_price(self, mark_price: MarkPriceUpdate) -> None: ...
    def _handle_index_price(self, index_price: IndexPriceUpdate) -> None: ...
    def _handle_bar(self, bar: Bar) -> None: ...
    def _handle_instrument_status(self, data: InstrumentStatus) -> None: ...
    def _handle_close_price(self, data: InstrumentClose) -> None: ...
    def _handle_custom_data(self, data: CustomData) -> None: ...
    def _handle_response(self, response: DataResponse) -> None: ...
    def _new_query_group(self, correlation_id: UUID4, n_components: int) -> None: ...
    def _handle_query_group(self, response: DataResponse) -> DataResponse | None: ...
    def _check_bounds(self, response: DataResponse) -> None: ...
    def _update_catalog(
        self,
        ticks: list,
        data_cls: type,
        identifier: Any,
        start: int | None = None,
        end: int | None = None,
        is_instrument: bool = False,
        force_update_catalog: bool = False,
    ) -> None: ...
    def _catalog_last_timestamp(
        self,
        data_cls: type,
        identifier = ...,
    ) -> tuple[datetime | None, object | None]: ...
    def _handle_instruments(self, instruments: list[Instrument], update_catalog: bool = False, force_update_catalog: bool = False) -> None: ...
    def _handle_quote_ticks(self, ticks: list[QuoteTick]) -> None: ...
    def _handle_trade_ticks(self, ticks: list[TradeTick]) -> None: ...
    def _handle_bars(self, bars: list[Bar], partial: Bar | None) -> None: ...
    def _handle_aggregated_bars(self, ticks: list, params: dict) -> dict: ...
    def _internal_update_instruments(self, instruments: list[Instrument]) -> None: ... # skip-validate
    def _update_order_book(self, data: Data) -> None: ...
    def _snapshot_order_book(self, snap_event: TimeEvent) -> None: ...
    def _publish_order_book(self, instrument_id: InstrumentId, topic: str) -> None: ...
    def _create_bar_aggregator(self, instrument: Instrument, bar_type: BarType) -> BarAggregator: ...
    def _start_bar_aggregator(self, client: MarketDataClient, command: SubscribeBars) -> None: ...
    def _stop_bar_aggregator(self, client: MarketDataClient, command: UnsubscribeBars) -> None: ...
    def _update_synthetics_with_quote(self, synthetics: list[SyntheticInstrument], update: QuoteTick) -> None: ...
    def _update_synthetic_with_quote(self, synthetic: SyntheticInstrument, update: QuoteTick) -> None: ...
    def _update_synthetics_with_trade(self, synthetics: list[SyntheticInstrument], update: TradeTick) -> None: ...
    def _update_synthetic_with_trade(self, synthetic: SyntheticInstrument, update: TradeTick) -> None: ...

